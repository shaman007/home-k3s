---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-secret-store
  namespace: test
spec:
  provider:
    vault:
      server: "http://192.168.1.111:8200"
      path: "kv"
      version: "v2"
      auth:
        tokenSecretRef:
          name: vault-token
          key: token
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: test 
  namespace: test
spec:
  refreshInterval: "1m"
  secretStoreRef:
    name: vault-secret-store
    kind: SecretStore
  target:
    name: test
    creationPolicy: Owner
  data:
    - secretKey: CRYPTO_KEY_PROVIDER
      remoteRef:
        key:  test
        property: CRYPTO_KEY_PROVIDER
    - secretKey: CRYPTO_KEY_VALUE
      remoteRef:
        key:  test
        property: CRYPTO_KEY_VALUE
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: test
  namespace: test
spec:
  storageClassName: "longhorn-crypto-per-volume"
  accessModes: 
    - ReadWriteOnce
  resources:
    requests:
      storage: 250Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test
  namespace: test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test
  template:
    metadata:
      labels:
        app: test
    spec:
      containers:
      - name: app-container
        image: nginx  # Example container
        volumeMounts:
        - name: data-volume
          mountPath: /usr/share/nginx/html  # Example path
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: test
---
apiVersion: v1
kind: Secret
metadata:
  name: vault-token
  namespace: test
data:
  token: >-
    aHZzLkNBRVNJT3gzcld5VXZOdkJhWWtBbmsxRGhxc0YzREplWGdWcFYwMFQwWUkxa2toNEdoNEtIR2gyY3k1bU1uZFNZM2xTZVZwRWNqaGFiMWhaV2xoVldERlJSVFU=
type: Opaque
