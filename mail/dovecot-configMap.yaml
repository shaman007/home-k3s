---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dovecot-cf
  namespace: mail
  labels:
    tier: mail
data:
  config: |
    dovecot_config_version = 2.4.0
    dovecot_storage_version = 2.4.0
    protocols = imap lmtp sieve
    service stats {
      unix_listener stats-reader {
        user = dovecot
        group = mail
        mode = 0666
      }
    unix_listener stats-writer {
      user = dovecot
      group = mail
      mode = 0666
      }
    }
    log_path = /dev/stdout
    # If not set, use the value from log_path
    info_log_path = /dev/stdout
    # If not set, use the value from info_log_path
    debug_log_path = /dev/stdout
    !include conf.d/*.conf
    !include_try local.conf
  10-auth: |
    auth_username_format = %{user | username}
    auth_mechanisms = PLAIN

    passdb passwd-file {
      passwd_file_path = /etc/dovecot/passwd
    }
    userdb passwd {
      # optional overrides here
    }
  10-mail: |
   # Dovecot 2.4+
   mail_driver = mbox
   mail_path = /var/mail/boxes/%{user | username}
   mail_inbox_path = /var/mail/%{user | username}

   namespace inbox {
     inbox = yes
   }

   # keep one line only (you had it twice)
   mbox_write_locks = fcntl

  10-master: |
   ## 10-master.conf â€” Dovecot 2.4

   service imap-login {
     inet_listener imap {
       port = 143
     }
     inet_listener imaps {
       port = 993
       ssl = yes
     }
   }

   service pop3-login {
     inet_listener pop3 {
       port = 110
     }
     inet_listener pop3s {
       port = 995
       ssl = yes
     }
   }

   service lmtp {
     inet_listener lmtp {
       port = 24
     }
   }

   service imap {
   }

   service pop3 {
   }

   service auth {
     unix_listener auth-userdb {
       mode = 0600
     }
     inet_listener auth {
       port = 1234
     }
   }

   service auth-worker {
   }

   service dict {
     unix_listener dict {
       mode = 0600
     }
   }


  10-ssl: |
    ssl = required
    ssl_server_cert_file = /var/certs/tls.crt
    ssl_server_key_file  = /var/certs/tls.key
  15-lda: |
    protocol lda {
      mail_plugins {
        sieve = yes
      }
    }

  20-lmtp: |
    protocol lmtp {
      mail_plugins {
        sieve = yes
      }
    }
  20-managesieve: |
    service managesieve-login {
      inet_listener sieve {
      port = 4190
      }
    }
    service managesieve {
    }
    protocol sieve {
      mail_max_userip_connections = 128
    }
  90-sieve: |
    sieve_script personal {
      driver = file
      path = /var/mail/sieve/%{user}
      active_path = /var/mail/sieve/%{user}/.dovecot.sieve
    }
