---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: nextcloud
  namespace: nextcloud
  labels:
    app: nextcloud
    tier: backend
    app.kubernetes.io/name: nextcloud
    app.kubernetes.io/instance: nextcloud
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: argoCD
spec:
  schedule: "15 * * * *"
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        metadata:
          labels:
            app: nextcloud
            tier: backend
            app.kubernetes.io/name: nextcloud
            app.kubernetes.io/instance: nextcloud
        spec:
          containers:
            - name: previews
              image: harbor.andreybondarenko.com/library/php:latest
              command:
                - /bin/sh
                - -c
                - "sleep 120; sudo -u www-data php /nextcloud/cron.php"
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  memory: 256Mi
              volumeMounts:
                - name: application-code
                  mountPath: /nextcloud
          volumes:
            - name: application-code
              persistentVolumeClaim:
                claimName: nextcloud-lh
            - name: config-volume
              configMap:
                name: php-fpm-config
          restartPolicy: Never
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: app
                        operator: In
                        values:
                          - nextcloud
                  topologyKey: kubernetes.io/hostname
