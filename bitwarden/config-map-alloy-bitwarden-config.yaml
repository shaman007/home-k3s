apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-bitwarden-config
  namespace: bitwarden
data:
  config.alloy: |
    livedebugging { enabled = true }

    // Match the same two globs you had in promtail.yaml
    local.file_match "bitwarden" {
      path_targets = [
        {
          __path__ = "/etc/bitwarden/logs/*.log",
          job      = "bitwarden",
        },
        {
          __path__ = "/var/log/bitwarden/*.log",
          job      = "bitwarden",
        },
      ]
    }

    loki.process "bitwarden" {
      forward_to = [loki.write.default.receiver]

      stage.decolorize { }

      // Optional: drop noisy endpoints
      stage.drop {
        expression = ".*(\\/health|\\/metrics|\\/ping).*"
      }
    }

    loki.source.file "bitwarden" {
      targets    = local.file_match.bitwarden.targets
      forward_to = [loki.process.bitwarden.receiver]

      // positions in a writable place
      legacy_positions_file = "/run/alloy/positions.yaml"
    }

    loki.write "default" {
      endpoint {
        url = "http://loki.loki.svc.cluster.local:3100/loki/api/v1/push"
      }
    }
